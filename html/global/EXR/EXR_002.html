<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="format-detection" content="telephone=no">
  <title>EXR_002</title>

  <link rel="stylesheet" href="../../../css/hmui/swiper.css">
  <link rel="stylesheet" href="../../../css/hmui/animate.css">
  <link rel="stylesheet" href="../../../css/hmui/common.css">
  <link rel="stylesheet" href="../../../css/global/contents.css">
  <script src="../../../js/hmui/lib/jquery-1.12.3.min.js"></script>
  <script src="../../../js/hmui/lib/swiper.js"></script>
  <script src="../../../js/hmui/lib/waypoints.min.js"></script>
  <script src="../../../js/hmui/lib/jquery.counterup.js"></script>
  <script src="../../../js/hmui/ui_common.js"></script>
</head>
<body>
  <main id="root">
    <header id="header">
      <div class="inner_fixed">
        <button class="btn_ico_prev"><span class="blind">이전</span></button>
        <h1>환율정보</h1>
        <button class="btn_ico_menu"><span class="blind">전체메뉴</span></button>
      </div>
    </header>
    <!-- // header -->

    <div id="contents" class="wrap_contents">
      <div class="contents">
        <section data-roll="EXR">
          <div class="wrap_top_info exr_info">
            <div class="wrap_dropdown fnCloseOut" data-type="exr">
              <button type="button" class="btn_dropdown type_big"><span class="current"><em class="txt_ccy"><span class="ico_cur_usd"></span>미국 USD 100</em></span></button>
              <div class="list_dropdown">
                <ul>
                  <!-- <li><button type="button"><span class="txt_ccy"><span class="ico_cur_usd"></span>USD</span></button></li> -->
                  <li><button type="button"><span class="txt_ccy dir_col"><span class="ico_cur_jpy"></span>JPY</span></button></li>
                  <li><button type="button"><span class="txt_ccy dir_col"><span class="ico_cur_eur"></span>EUR</span></button></li>
                  <li><button type="button"><span class="txt_ccy dir_col"><span class="ico_cur_gbp"></span>GBP</span></button></li>
                  <li><button type="button"><span class="txt_ccy dir_col"><span class="ico_cur_cny"></span>CNY</span></button></li>
                  <li><button type="button"><span class="txt_ccy dir_col"><span class="ico_cur_sgd"></span>SGD</span></button></li>
                  <li><button type="button"><span class="txt_ccy dir_col"><span class="ico_cur_vnd"></span>VND</span></button></li>
                  <li><button type="button"><span class="txt_ccy dir_col"><span class="ico_cur_cad"></span>CAD</span></button></li>
                  <li><button type="button"><span class="txt_ccy dir_col"><span class="ico_cur_aud"></span>AUD</span></button></li>
                </ul>
              </div>
            </div>
            <div class="exch_rate_info">
              <div class="left">
                <p class="txt_amount_gap up">전날 대비 <em class="txt_num">-3.50</em></p>
                <p class="txt_amount_gap down">전주 대비 <em class="txt_num">+12.60</em></p>
                <p class="txt_amount_gap equal">전주 대비 <em class="txt_num">0.00</em></p>
              </div>
              <div class="right">
                <p class="txt_type">매매기준율</p>
                <p class="txt_amount up"><em class="txt_num">1,355.60</em>원</p>
                <p class="txt_amount down"><em class="txt_num">1,355.60</em>원</p>
                <p class="txt_amount equal"><em class="txt_num">1,355.60</em>원</p>
              </div>
            </div>
            <div class="fnSimpleAcco">
              <div class="wrap_acco">
                <button class="btn_refresh">2022.08.30 15:21 (95회차)<span class="ico_refresh_s"><span class="blind">새로고침</span></button>
                <ul class="list_info">
                  <li>
                    <span class="tit">매매기준율</span>
                    <span class="txt"><em class="txt_num">1,355.60</em>원</span>
                  </li>
                  <li>
                    <span class="tit">현찰 살 때</span>
                    <span class="txt"><em class="txt_num">1,355.60</em>원</span>
                  </li>
                  <li>
                    <span class="tit">현찰 팔 때</span>
                    <span class="txt"><em class="txt_num">1,355.60</em>원</span>
                  </li>
                  <li>
                    <span class="tit">송금 보낼 때</span>
                    <span class="txt"><em class="txt_num">1,355.60</em>원</span>
                  </li>
                  <li>
                    <span class="tit">송금 받을 때</span>
                    <span class="txt"><em class="txt_num">1,355.60</em>원</span>
                  </li>
                </ul>
              </div>
              <button type="button" class="btn_acco">상세환율 보기<span class="ico_arr_down_2"></span></button>
            </div>
            <div class="wrap_btn type_col">
              <a href="#none" class="btn_round_m type_line"><span class="txt">목표환율 자동충전</span></a>
              <a href="#none" class="btn_round_m btn_primary"><span class="txt">바로 충전</span></a>
            </div>
          </div>

          <div class="wrap_detail_exr">
            <div class="section_tab type_sub_line">
              <ul class="wrap_tab_btn">
                <li class="on"><button type="button" class="btn_tab_box">1w</button></li>
                <li><button type="button" class="btn_tab_box">1m</button></li>
                <li><button type="button" class="btn_tab_box">3m</button></li>
                <li><button type="button" class="btn_tab_box">6m</button></li>
                <li><button type="button" class="btn_tab_box">1y</button></li>
              </ul>
            </div>

            <div class="wrap_chart">
              <canvas id="lineChart_exr002" class="line_chart"></canvas>
            </div>

            <div class="wrap_exch_monthly">
              <p class="tit">최근 1개월동안<br>
                <strong>다른 사람들은 얼마에 환전</strong>했을까요?</p>
              <p class="wrap_info_exchange">
                <span class="txt_info txt_point_1"><span>USD</span> 1 = <span class="txt_num">1,340.10</span>원</span>
              </p>
              <p class="txt_basis">22.08.08 ~ 22.09.08 평균 매입가</p>
            </div>

            <div class="wrap_box bg_darkgrey">
              <div class="box_tit">
                <p class="tit"><span>김하나</span>님의 <span>달러머니</span></p>
                <span class="txt">최근 1년 기준</span>
              </div>
              <!-- 거래내역 있을 시 / 데이터 로드 전 default로 노출  -->
              <div>
                <ul class="list_info">
                  <li>
                    <span class="tit">내가 산 최저가</span>
                    <span class="txt"><span class="emoji_lowest"></span><em class="txt_num">1,355.60</em>원</span>
                  </li>
                  <li>
                    <span class="tit">내가 산 최고가</span>
                    <span class="txt"><span class="emoji_highest"></span><em class="txt_num">1,355.60</em>원</span>
                  </li>
                  <li>
                    <span class="tit">나의 <span>달러머니</span> 평균가</span>
                    <span class="txt"><span class="emoji_avg"></span><em class="txt_num">1,355.60</em>원</span>
                  </li>
                </ul>
                <div class="txt_total">
                  <strong class="tit">아낀 환전수수료</strong>
                  <span class="txt txt_point_1"><em class="txt_num">3,400,000</em>원</span>
                </div>
              </div>
              <!-- // 거래내역 있을 시 -->
              <!-- 거래내역 없을 시 -->
              <div class="no_result" style="display: none;">
                <p>최근 1년간 거래하신 내역이 없어요.</p>
                <div class="wrap_btn">
                  <a href="#none" class="btn_round_m btn_primary">환율 100% 우대받고 충전하기</a>
                </div>
              </div>
              <!-- // 거래내역 없을 시 -->
            </div>

          </div>
        </section>
        <!-- 하단고정영역 -->
        <div class="section_bottom_fixed type_noFullBtn">
          <a href="#none" class="btn_round_ico bg_black fnScrollEnd"><span class="ico_alarm"></span><span class="txt">환율 알림 설정</span></a>
        </div>
        <!-- // 하단고정영역 -->
      </div>
    </div> 
    <!-- // contents-->
  </main>

  <script src="../../../js/hmui/lib/chart.js"></script>
  <script src="../../../js/hmui/lib/chartjs-plugin-annotation.js"></script>
  <script src="../../../js/hmui/chart/chart_EXR002.js"></script>
  
  <script>
    // 차트 data 선언 
    var labels = [],
        lineChart_exr002 = [];

    // 데이터 확인용 샘플
    labels = ['22.10.01','22.10.02','22.10.03','22.10.04','22.10.05','22.10.06','22.10.07',];
    lineChart_exr002 = [1500.12, 1500.15, 1411.32, 1481.32, 1433.76, 1451.90, 1500.52];

    // Max Point
    function maxValue(ctx) {
      let max = 0;
      const dataset = ctx.chart.data.datasets[0];
      dataset.data.forEach(function(el) {
        max = Math.max(max, el);
      });
      return max;
    }
    function maxIndex(ctx) {
      const max = maxValue(ctx);
      const dataset = ctx.chart.data.datasets[0];
      return dataset.data.indexOf(max);
    }
    function maxLabel(ctx) {
      return ctx.chart.data.labels[maxIndex(ctx)];
    }
    var maxPoint = {
      type: 'point',
      radius: 5,
      borderWidth: '3',
      borderColor: '#FF5166',
      backgroundColor: '#323E43',
      backgroundShadowColor: 'rgba(245, 46, 70, 0.8)',
      shadowBlur: 16,
      shadowOffsetX: 0,
      shadowOffsetY: 5,
      scaleID: 'y',
      xValue: (ctx) => maxLabel(ctx),
      yValue: (ctx) => maxValue(ctx)
    }
    var maxText = {
      type: 'label',
      color: '#FF5166',
      content: (ctx) => '최고 ' + maxValue(ctx).toFixed(2) + '원',
      font: {
        size: 16
      },
      position: {
        x: (ctx) => maxIndex(ctx) <= 3 ? 'start' : maxIndex(ctx) >= 10 ? 'end' : 'center',
        y: 'end'
      },
      xValue: (ctx) => maxLabel(ctx),
      yAdjust: -6,
      yValue: (ctx) => maxValue(ctx)
    }

    // Min Point
    function minValue(ctx) {
      const dataset = ctx.chart.data.datasets[0];
      let min = dataset.data[0];
      dataset.data.forEach(function(el) {
        min = Math.min(min, el);
      });
      return min;
    }
    function minIndex(ctx) {
      const min = minValue(ctx);
      const dataset = ctx.chart.data.datasets[0];
      return dataset.data.indexOf(min);
    }
    function minLabel(ctx) {
      return ctx.chart.data.labels[minIndex(ctx)];
    }
    var minPoint = {
      type: 'point',
      radius: 5,
      borderWidth: '3',
      borderColor: '#308FFF',
      backgroundColor: '#323E43',
      backgroundShadowColor: 'rgba(48, 143, 255, 0.8)',
      shadowBlur: 16,
      shadowOffsetX: 0,
      shadowOffsetY: 5,
      scaleID: 'y',
      xValue: (ctx) => minLabel(ctx),
      yValue: (ctx) => minValue(ctx)
    }
    var minText = {
      type: 'label',
      color: '#308FFF',
      content: (ctx) => '최저 ' + minValue(ctx).toFixed(2) + '원',
      font: {
        size: 16
      },
      position: {
        x: (ctx) => minIndex(ctx) <= 3 ? 'start' : minIndex(ctx) >= 10 ? 'end' : 'center',
        y: 'start'
      },
      xValue: (ctx) => minLabel(ctx),
      yAdjust: 4,
      yValue: (ctx) => minValue(ctx)
    }


    // average line
    function average(ctx) {
      var values = ctx.chart.data.datasets[0].data;
      return values.reduce((a, b) => a + b, 0) / values.length;
    }
    var averageline = {
      id: 'averageline',
      type: 'line',
      borderColor: 'rgba(255,255,255,0.4)',
      borderRadius: 4,
      borderDash: [2, 2],
      borderDashOffset: 0,
      borderWidth: 1,
      label: {
        display: true,
        padding: 4,
        backgroundColor: 'rgba(37,46,51,0.9)',
        color: 'rgba(183,197,200,1)',
        font: {
          size: 12,
          lineHeight: 1,
        },
        content: (ctx) => '평균 ' + average(ctx).toFixed(2) + '원',
        position: 'start',
        xAdjust: -4,
      },
      scaleID: 'y',
      value: (ctx) => average(ctx),
      // enter({element}, event) {
      //   element.label.options.display = false;
      //   return true;
      // },
      // leave({element}, event) {
      //   element.label.options.display = true;
      //   return true;
      // }
    };

    // tooltip drag line 
    var tooltipLine = {
      id: 'tooltipLine',
      beforeDraw: function(chart){
        if (chart.tooltip._active && chart.tooltip._active.length) {
          var ctx = chart.ctx;
          ctx.save();
          var activePoint = chart.tooltip._active[0];
          ctx.beginPath();
          ctx.moveTo(activePoint.element.x, chart.chartArea.top - 57);
          ctx.lineTo(activePoint.element.x, chart.chartArea.bottom + 32);
          ctx.lineWidth = 1;
          ctx.strokeStyle = 'rgba(255,255,255,0.4)';
          ctx.stroke();
          ctx.restore();
        }
      }
    }

    // tooltip position custom
    Chart.Tooltip.positioners.custom = function(elements, position) {
      var tooltip = this;
      if (!elements.length) {
        return false;
      }
      // console.log(position);
      var offset = position.x <= tooltip.chart.width/2 ? position.x : position.x;
      return {
        x: offset,
        y: 0
      }
    }

    // chart 옵션
    const config = {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: '환율',
          backgroundColor: 'transparent',
          borderColor: 'rgb(255, 240, 189)',
          pointRadius: 0,
          data: lineChart_exr002,
        }]
      },
      options: {
        maintainAspectRatio: false,
        borderWidth: 1,
        pointHoverRadius: 0,
        layout: {
          padding: {
            top: 57,
            bottom: 58,
            right: 24,
            left: 24,
          }
        },
        scales: {
          x: {
            display: true,
            grid: {
              display: false,
              drawBorder: false
            },
            ticks: {
              display: false,
              drawTicks: false
            }
          },
          y: {
            display: false,
            grid: {
              display: false,
              drawBorder: false
            },
            ticks: {
              display: false,
              drawTicks: false
            }
          }
        },
        interaction: {
          mode: 'x',
          intersect: false,
        },
        plugins: {
          annotation: {
            clip: false,
            enter(ctx) {
              element = ctx.element;
              // console.log(element);
            },
            leave() {
              element = undefined;
              lastEvent = undefined;
            },
            annotations: {
              averageline,
              maxPoint,
              maxText,
              minPoint,
              minText,
            }
          },
          title: {
            display: false
          },
          subtitle: {
            display: false
          },
          legend: {
            display: false,
          },
          tooltip: {
            // enabled: false,
            // position: 'nearest',
            // external: externalTooltipHandler
            mode: 'nearest',
            intersect: false,
            position: 'custom',
            yAlign: 'bottom',
            padding: '0 8 0 8',
            displayColors: false,
            backgroundColor: 'transparent',
            titleColor: '#9DAAB0',
            titleFont: {
              family: "'Spoqa',-apple-system,helvetica,Apple SD Gothic Neo,sans-serif",
              size: 12
            },
            bodyFont: {
              family: "'Spoqa',-apple-system,helvetica,Apple SD Gothic Neo,sans-serif",
              size: 15
            },
            callbacks: {
              label: function(tooltipItems) {
                return tooltipItems.formattedValue + '원';
              }
            },
          },
        }
      },
      plugins: [tooltipLine]
    };

    /**
      * @name updateChart()
      * @description chart 업데이트
      * @param {Object} chart 
      * @param {Array} labels
      * @param {Array} data 
      */
      function updateChart(el, newLabels, newData) {
        el.data.datasets.forEach(function(dataset) {
          dataset.data = newData;
        });
        el.update();
      }

    $(function(){
      // 차트생성
      var chartEXR = new Chart(
        $('#lineChart_exr002'),
        config
      );

      $('.btn_refresh').on('click', function(){
        // 로딩 시 param element class
        skeletonLoading.start('.exr_info, .wrap_detail_exr'); // 텍스트로딩
        skeletonLoading.start('.wrap_chart'); // 차트로딩


        // 데이터 업데이트 확인용 샘플
        lineChart_exr002 = [100, 0, 5, 2, 20, 30, 45];

        setTimeout(function(){
          // 로딩 완료 시 param element class
          skeletonLoading.end('.exr_info, .wrap_detail_exr');
          skeletonLoading.end('.wrap_chart');

          // 차트 업데이트 
          updateChart(chartEXR, labels, lineChart_exr002);
        },2000);
      });

      // 환율상세보기 버튼 클릭 시 텍스트 변경
      $('.btn_acco').on('click', function(){
        var text = $(this).text();
        if ($(this).hasClass('on')) {
          $(this).html('상세환율 닫기<span class="ico_arr_down_2"></span>');
        } else {
          $(this).html('상세환율 보기<span class="ico_arr_down_2"></span>');
        }
      }); 
    });
  </script>
  
</body>
</html>